<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { background-color: #fff7ed; color: #ea580c; border-right: 4px solid #ea580c; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-l border-gray-200 hidden md:flex flex-col">
        <div class="p-6 text-center border-b border-gray-100">
            <img id="d-logo" src="images/logo.png" class="w-20 h-20 mx-auto rounded-xl mb-2 object-contain border p-1">
            <h2 id="d-name" class="font-bold text-gray-800">...</h2>
            <div id="plan-badge" class="inline-block px-3 py-1 rounded-full text-xs font-bold mt-2 bg-gray-100 text-gray-500">Free</div>
        </div>
        <nav class="p-4 space-y-1 flex-1">
            <button onclick="switchTab('home', this)" class="nav-btn active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 font-bold transition hover:bg-gray-50"><i class="fa-solid fa-chart-pie w-6"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="switchTab('products', this)" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 font-bold transition hover:bg-gray-50"><i class="fa-solid fa-burger w-6"></i> Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
            <button onclick="switchTab('settings', this)" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 font-bold transition hover:bg-gray-50"><i class="fa-solid fa-gear w-6"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button onclick="switchTab('qr', this)" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-600 font-bold transition hover:bg-gray-50"><i class="fa-solid fa-qrcode w-6"></i> Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
        </nav>
        <div class="p-4">
            <a href="index.html" class="block w-full text-center bg-red-50 text-red-500 py-2 rounded-xl font-bold hover:bg-red-100 transition">Ø®Ø±ÙˆØ¬</a>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto p-8 bg-gray-50">
        
        <div id="tab-home" class="tab-content active">
            <h1 class="text-3xl font-black text-gray-800 mb-6">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© ğŸ“ˆ</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-gray-400 text-xs font-bold mb-1">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ</p>
                    <h3 class="text-4xl font-black text-orange-500" id="stat-views">0</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-gray-400 text-xs font-bold mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                    <h3 class="text-4xl font-black text-blue-500" id="stat-prods">0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm h-80">
                <canvas id="viewsChart"></canvas>
            </div>
        </div>

        <div id="tab-products" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-black text-gray-800">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ğŸ”</h1>
                <button onclick="document.getElementById('p-modal').style.display='flex'" class="bg-orange-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-orange-600 transition shadow-lg shadow-orange-200"><i class="fa-solid fa-plus"></i> Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="tab-settings" class="tab-content">
            <h1 class="text-2xl font-black text-gray-800 mb-6">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ âš™ï¸</h1>
            <div class="bg-white p-8 rounded-2xl shadow-sm max-w-2xl space-y-4 border border-gray-100">
                <div><label class="block font-bold mb-1 text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</label><input type="text" id="s-name" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500"></div>
                <div><label class="block font-bold mb-1 text-gray-700">ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (966..)</label><input type="text" id="s-phone" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500"></div>
                <div><label class="block font-bold mb-1 text-gray-700">Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ</label><input type="text" id="s-logo" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500"></div>
                <div>
                    <label class="block font-bold mb-1 text-gray-700">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="s-color" class="w-16 h-12 rounded-lg cursor-pointer border-0 p-0">
                        <p class="text-xs text-gray-400" id="color-msg">ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…ØªØ§Ø­ Ù„Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ÙˆØ§Ù„Ù€ VIP ÙÙ‚Ø·</p>
                    </div>
                </div>
                <button onclick="saveSettings()" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold mt-4 hover:bg-black transition">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>

        <div id="tab-qr" class="tab-content">
            <h1 class="text-2xl font-black text-gray-800 mb-6">Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ğŸ“±</h1>
            <div class="bg-white p-10 rounded-2xl shadow-sm text-center max-w-md mx-auto border border-gray-100">
                <img id="qr-img" src="" class="w-48 h-48 mx-auto mb-4 border-2 p-2 rounded-xl">
                <a id="menu-link" href="#" target="_blank" class="text-blue-500 font-bold underline mb-6 block hover:text-blue-600">ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ÙŠÙˆ</a>
                <button onclick="window.print()" class="bg-blue-50 text-blue-600 px-6 py-2 rounded-xl font-bold hover:bg-blue-100 transition"><i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø©</button>
            </div>
        </div>

    </main>

    <div id="p-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-md relative shadow-2xl">
            <button onclick="document.getElementById('p-modal').style.display='none'" class="absolute top-5 right-5 text-gray-400 hover:text-black"><i class="fa-solid fa-times text-xl"></i></button>
            <h3 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
            <div class="space-y-3">
                <input id="prod-name" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                <div class="flex gap-3">
                    <input id="prod-price" type="number" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                    <select id="prod-cat" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500"><option>Ø¹Ø±ÙˆØ¶</option><option>Ø£Ø·Ø¨Ø§Ù‚</option><option>Ø­Ù„Ø§</option><option>Ù…Ø´Ø±ÙˆØ¨Ø§Øª</option></select>
                </div>
                <input id="prod-img" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                <textarea id="prod-desc" class="w-full bg-gray-50 border rounded-xl p-3 outline-none focus:border-orange-500 h-24" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
            </div>
            <button onclick="addProduct()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold mt-4 hover:bg-orange-600 transition shadow-lg shadow-orange-200">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, updateDoc, arrayUnion } from './firebase-config.js';

        const restId = localStorage.getItem('admin_rest_id');
        if(!restId) window.location.href = "index.html"; 

        // Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø¨Ø§Ù‚Ø§Øª ğŸ“œ
        const PLANS = {
            'free': { limit: 5, color: false, label: "Ù…Ø¬Ø§Ù†ÙŠØ© (Free)", bg: "bg-gray-100 text-gray-500" },
            'gold': { limit: 50, color: true, label: "Ø°Ù‡Ø¨ÙŠØ© (Gold)", bg: "bg-yellow-100 text-yellow-600" },
            'vip': { limit: 9999, color: true, label: "Ø¨Ù„Ø§ØªÙŠÙ†ÙŠØ© (VIP)", bg: "bg-purple-100 text-purple-600" }
        };

        let currentData = {};

        async function init() {
            const snap = await getDoc(doc(db, "restaurants", restId));
            if(snap.exists()) {
                currentData = snap.data();
                const plan = PLANS[currentData.plan || 'free'];

                // Sidebar Info
                document.getElementById('d-name').innerText = currentData.name;
                document.getElementById('d-logo').src = currentData.logo;
                
                // Badge Update
                const badge = document.getElementById('plan-badge');
                badge.innerText = plan.label;
                badge.className = `inline-block px-3 py-1 rounded-full text-xs font-bold mt-2 ${plan.bg}`;

                // Stats
                document.getElementById('stat-views').innerText = currentData.stats.views || 0;
                document.getElementById('stat-prods').innerText = currentData.products?.length || 0;

                // Products Render
                const grid = document.getElementById('products-grid');
                grid.innerHTML = (currentData.products || []).map(p => `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:border-orange-200 transition">
                        <div class="relative h-40">
                            <img src="${p.image}" class="w-full h-full object-cover" onerror="this.src='images/logo.png'">
                            <div class="absolute top-2 right-2 bg-white/90 px-2 py-1 rounded text-[10px] font-bold shadow-sm">${p.category}</div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between font-bold mb-1"><h3>${p.name}</h3><span class="text-orange-500">${p.price} Ø±.Ø³</span></div>
                            <p class="text-xs text-gray-400 mt-1 truncate">${p.description || ''}</p>
                        </div>
                    </div>`).join('');

                // Settings Fill
                document.getElementById('s-name').value = currentData.name;
                document.getElementById('s-phone').value = currentData.phone;
                document.getElementById('s-logo').value = currentData.logo;
                document.getElementById('s-color').value = currentData.themeColor;
                
                // Color Lock Logic
                if(!plan.color) {
                    document.getElementById('s-color').disabled = true;
                    document.getElementById('s-color').classList.add('opacity-50', 'cursor-not-allowed');
                    document.getElementById('color-msg').innerHTML = `<i class="fa-solid fa-lock"></i> Ø§Ù„ØªØºÙŠÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙÙ‚Ø·`;
                    document.getElementById('color-msg').classList.add('text-red-400');
                } else {
                    document.getElementById('color-msg').innerText = "ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ù†ÙŠÙˆ";
                    document.getElementById('color-msg').classList.add('text-green-500');
                }

                // QR Code
                const link = window.location.origin + window.location.pathname.replace('client_dashboard.html', '') + `menu.html?id=${restId}`;
                document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
                document.getElementById('menu-link').href = link;

                // Chart
                new Chart(document.getElementById('viewsChart'), {
                    type: 'line',
                    data: { labels: ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'], datasets: [{label: 'Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª', data: [0,0,0,0,0,0,currentData.stats.views || 0], borderColor: '#f97316', tension: 0.4, fill: true, backgroundColor: '#ffedd5'}] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}} }
                });
            }
        }

        window.addProduct = async () => {
            const plan = PLANS[currentData.plan || 'free'];
            const currentCount = (currentData.products || []).length;

            if (currentCount >= plan.limit) {
                alert(`â›” Ø¹ÙÙˆØ§Ù‹! Ø¨Ø§Ù‚ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (${plan.label}) ØªØ³Ù…Ø­ Ø¨Ù€ ${plan.limit} Ù…Ù†ØªØ¬Ø§Øª ÙÙ‚Ø·.\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„ØªØ±Ù‚ÙŠØ©.`);
                return;
            }

            const p = {
                name: document.getElementById('prod-name').value,
                price: Number(document.getElementById('prod-price').value),
                category: document.getElementById('prod-cat').value,
                image: document.getElementById('prod-img').value || 'images/logo.png',
                description: document.getElementById('prod-desc').value
            };
            await updateDoc(doc(db, "restaurants", restId), { products: arrayUnion(p) });
            alert("âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸");
            document.getElementById('p-modal').style.display='none';
            init();
        }

        window.saveSettings = async () => {
            const plan = PLANS[currentData.plan || 'free'];
            const newColor = document.getElementById('s-color').value;

            // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù„Ùˆ Ø­Ø¯ Ù„Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù€ HTML)
            if (!plan.color && newColor !== currentData.themeColor) {
                alert("â›” ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨Ø§Ù‚Ø© Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù†!");
                return;
            }

            await updateDoc(doc(db, "restaurants", restId), {
                name: document.getElementById('s-name').value,
                phone: document.getElementById('s-phone').value,
                logo: document.getElementById('s-logo').value,
                themeColor: newColor
            });
            alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
            init();
        }

        window.switchTab = (tab, btn) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            btn.classList.add('active');
        }

        init();
    </script>
</body>
</html>
