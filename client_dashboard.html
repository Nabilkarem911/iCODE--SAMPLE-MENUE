<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø·Ø¹Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .sidebar-link { transition: all 0.3s; border-right: 4px solid transparent; }
        .sidebar-link.active { background-color: #fff7ed; color: #ea580c; border-right-color: #ea580c; }
        .tab-section { display: none; animation: fadeIn 0.4s ease-in-out; }
        .tab-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‚ÙÙˆÙ„Ø© Ù„Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© */
        .locked-feature { opacity: 0.6; pointer-events: none; filter: grayscale(1); position: relative; }
        .lock-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444; font-size: 20px; z-index: 10; display: none; }
        .locked-feature .lock-icon { display: block; }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-gray-50">

    <aside class="w-72 bg-white border-l border-gray-200 hidden md:flex flex-col shadow-sm z-20">
        <div class="p-6 text-center border-b border-gray-100">
            <div class="relative w-24 h-24 mx-auto mb-3">
                <img id="dash-logo" src="images/logo.png" class="w-full h-full rounded-2xl object-contain border border-gray-200 p-1 bg-white">
                <div id="status-dot" class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
            </div>
            <h2 id="dash-name" class="font-black text-gray-800 text-lg truncate">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            
            <div id="plan-badge-container" class="mt-2">
                <span id="plan-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500 border border-gray-200">ØªØ­Ù…ÙŠÙ„...</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <button onclick="switchTab('home', this)" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 font-bold hover:bg-gray-50">
                <i class="fa-solid fa-chart-pie w-6 text-center"></i> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
            </button>
            <button onclick="switchTab('products', this)" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 font-bold hover:bg-gray-50">
                <i class="fa-solid fa-burger w-6 text-center"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            </button>
            <button onclick="switchTab('settings', this)" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 font-bold hover:bg-gray-50">
                <i class="fa-solid fa-sliders w-6 text-center"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ
            </button>
            <button onclick="switchTab('qr', this)" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 font-bold hover:bg-gray-50">
                <i class="fa-solid fa-qrcode w-6 text-center"></i> Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ù„Ø±Ø§Ø¨Ø·
            </button>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <a href="index.html" onclick="localStorage.removeItem('admin_rest_id')" class="flex items-center justify-center gap-2 w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold hover:bg-red-100 transition">
                <i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
            </a>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="md:hidden bg-white border-b p-4 flex justify-between items-center shadow-sm z-20">
            <div class="flex items-center gap-2">
                <img src="images/logo.png" class="w-8 h-8 rounded-lg">
                <span class="font-bold text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
            </div>
            <button onclick="alert('ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù† Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù„Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©')" class="text-gray-500"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth">
            
            <div id="tab-home" class="tab-section active space-y-6">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h1 class="text-3xl font-black text-gray-800">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h1>
                        <p class="text-gray-500 text-sm mt-1">Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ù…Ø·Ø¹Ù…Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</p>
                    </div>
                    <div class="text-left hidden md:block">
                        <p class="text-xs text-gray-400 font-bold">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</p>
                        <p class="text-green-500 font-bold flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Ù†Ø´Ø·</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-orange-50 rounded-xl text-orange-500"><i class="fa-solid fa-eye text-xl"></i></div>
                            <span class="text-xs font-bold text-green-500 bg-green-50 px-2 py-1 rounded-lg">+12%</span>
                        </div>
                        <p class="text-gray-400 text-xs font-bold uppercase">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</p>
                        <h3 class="text-4xl font-black text-gray-800 mt-1" id="stat-views">0</h3>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-blue-50 rounded-xl text-blue-500"><i class="fa-solid fa-burger text-xl"></i></div>
                            <span id="products-limit-badge" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-lg">Limit: --</span>
                        </div>
                        <p class="text-gray-400 text-xs font-bold uppercase">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
                        <h3 class="text-4xl font-black text-gray-800 mt-1" id="stat-prods">0</h3>
                    </div>

                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10"></div>
                        <p class="text-gray-400 text-xs font-bold uppercase mb-4">Ø¨Ø§Ù‚ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                        <h3 class="text-2xl font-black mb-1" id="stat-plan">...</h3>
                        <p class="text-xs text-gray-400 mb-4" id="stat-expiry">ØªÙ†ØªÙ‡ÙŠ ÙÙŠ: ...</p>
                        <button onclick="window.open('https://wa.me/966500000000', '_blank')" class="w-full bg-white/10 hover:bg-white/20 py-2 rounded-lg text-xs font-bold transition">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨Ø§Ù‚Ø© ğŸš€</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-80">
                    <h3 class="font-bold text-gray-800 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙˆØ§Ø±</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="viewsChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-products" class="tab-section space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 class="text-3xl font-black text-gray-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¹Ø§Ù… ğŸ”</h1>
                        <p class="text-gray-500 text-sm">Ø£Ø¶Ù ÙˆØ¹Ø¯Ù„ Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø¨Ø³Ù‡ÙˆÙ„Ø©</p>
                    </div>
                    <button onclick="openProductModal()" class="w-full md:w-auto bg-orange-500 hover:bg-orange-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-orange-200 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>

                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
            </div>

            <div id="tab-settings" class="tab-section space-y-6">
                <div>
                    <h1 class="text-3xl font-black text-gray-800">ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ù†ÙŠÙˆ ğŸ¨</h1>
                    <p class="text-gray-500 text-sm">ØªØ­ÙƒÙ… ÙÙŠ Ù‡ÙˆÙŠØ© Ù…Ø·Ø¹Ù…Ùƒ ÙˆØ£Ù„ÙˆØ§Ù†Ù‡</p>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 max-w-3xl">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-2">
                            <label class="font-bold text-gray-700 text-sm">Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù…</label>
                            <input type="text" id="set-name" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 transition">
                        </div>
                        <div class="space-y-2">
                            <label class="font-bold text-gray-700 text-sm">Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
                            <input type="text" id="set-phone" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 transition" placeholder="Ù…Ø«Ø§Ù„: 966500000000">
                            <p class="text-[10px] text-gray-400">Ø³ØªØµÙ„ Ø¹Ù„ÙŠÙ‡ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                        </div>
                        <div class="space-y-2 md:col-span-2">
                            <label class="font-bold text-gray-700 text-sm">Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Logo URL)</label>
                            <input type="text" id="set-logo" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 transition">
                        </div>
                    </div>

                    <div class="border-t border-gray-100 pt-6 mb-6">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-palette text-purple-500"></i> Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ù†ÙŠÙˆ
                        </h3>
                        
                        <div id="color-section" class="flex items-center gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="relative">
                                <input type="color" id="set-color" class="w-16 h-12 rounded cursor-pointer border-0 p-0 bg-transparent">
                                <i class="fa-solid fa-lock lock-icon"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-700">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Theme Color)</p>
                                <p id="color-msg" class="text-xs text-gray-400">Ù…ØªØ§Ø­ Ù„Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ÙˆØ§Ù„Ù€ VIP</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveSettings()" class="w-full bg-gray-900 hover:bg-black text-white py-4 rounded-xl font-bold transition shadow-lg">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </div>
            </div>

            <div id="tab-qr" class="tab-section space-y-6">
                <div>
                    <h1 class="text-3xl font-black text-gray-800">Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ğŸ“±</h1>
                    <p class="text-gray-500 text-sm">Ø´Ø§Ø±Ùƒ Ø§Ù„Ù…Ù†ÙŠÙˆ Ù…Ø¹ Ø¹Ù…Ù„Ø§Ø¦Ùƒ</p>
                </div>

                <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 text-center max-w-md mx-auto">
                    <div class="bg-white p-4 rounded-2xl border-2 border-dashed border-gray-200 inline-block mb-6 relative group">
                        <img id="qr-img" src="" class="w-48 h-48 object-contain">
                        <div class="absolute inset-0 bg-white/80 hidden group-hover:flex items-center justify-center font-bold text-gray-800 cursor-pointer">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„</div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ù„ÙØªØ­ Ø§Ù„Ù…Ù†ÙŠÙˆ</h3>
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 flex justify-between items-center mb-6">
                        <a id="menu-link-text" href="#" target="_blank" class="text-sm text-blue-600 font-bold truncate px-2 hover:underline">...</a>
                        <button onclick="copyMenuLink()" class="text-gray-500 hover:text-gray-800 p-2"><i class="fa-solid fa-copy"></i></button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.print()" class="bg-blue-50 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-100 transition"><i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</button>
                        <button onclick="window.open(document.getElementById('menu-link-text').href, '_blank')" class="bg-gray-900 text-white py-3 rounded-xl font-bold hover:bg-gray-700 transition"><i class="fa-solid fa-arrow-up-right-from-square"></i> ÙØªØ­</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="product-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl relative flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h3>
                <button onclick="closeProductModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-red-50 hover:text-red-500 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <input id="prod-name" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 focus:bg-white transition" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±Ø¬Ø± Ø¯Ø¬Ø§Ø¬">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ø³Ø¹Ø± (Ø±.Ø³)</label>
                        <input id="prod-price" type="number" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 focus:bg-white transition" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ù‚Ø³Ù…</label>
                        <div class="relative">
                            <input list="categories-list" id="prod-cat" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 focus:bg-white transition" placeholder="Ø§Ø®ØªØ§Ø± Ø£Ùˆ Ø§ÙƒØªØ¨">
                            <datalist id="categories-list">
                                <option value="Ø¹Ø±ÙˆØ¶">
                                <option value="Ø£Ø·Ø¨Ø§Ù‚ Ø±Ø¦ÙŠØ³ÙŠØ©">
                                <option value="Ù…Ù‚Ø¨Ù„Ø§Øª">
                                <option value="Ù…Ø´Ø±ÙˆØ¨Ø§Øª">
                                <option value="Ø­Ù„Ø§">
                            </datalist>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label>
                    <input id="prod-img" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 focus:bg-white transition" placeholder="https://...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label>
                    <textarea id="prod-desc" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none focus:border-orange-500 focus:bg-white transition h-24 resize-none" placeholder="Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ¬Ø¨Ø©..."></textarea>
                </div>
            </div>

            <div class="p-6 border-t border-gray-100 bg-gray-50 rounded-b-3xl">
                <button onclick="saveProduct()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-orange-200 transition">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, updateDoc, arrayUnion } from './firebase-config.js';

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
        const restId = localStorage.getItem('admin_rest_id');
        if (!restId) window.location.href = "index.html";

        // 2. Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø¨Ø§Ù‚Ø§Øª (Ø§Ù„ØµØ§Ø±Ù…Ø©)
        const PLANS_CONFIG = {
            'free': { limit: 5, color: false, name: 'Ù…Ø¬Ø§Ù†ÙŠØ©', badgeClass: 'bg-gray-100 text-gray-600' },
            'gold': { limit: 50, color: true, name: 'Ø°Ù‡Ø¨ÙŠØ©', badgeClass: 'bg-yellow-100 text-yellow-700' },
            'vip': { limit: 9999, color: true, name: 'Ø¨Ù„Ø§ØªÙŠÙ†ÙŠØ©', badgeClass: 'bg-purple-100 text-purple-700' }
        };

        let currentData = {};

        // 3. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
        async function initDashboard() {
            try {
                const docRef = doc(db, "restaurants", restId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentData = docSnap.data();
                    renderUI();
                } else {
                    alert("Ø¹ÙÙˆØ§Ù‹ØŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø¹Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                    window.location.href = "index.html";
                }
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        // 4. Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        function renderUI() {
            const planKey = currentData.plan || 'free';
            const planRules = PLANS_CONFIG[planKey];
            const products = currentData.products || [];

            // Sidebar Info
            document.getElementById('dash-name').innerText = currentData.name;
            document.getElementById('dash-logo').src = currentData.logo || 'images/logo.png';
            
            // Plan Badge
            const badge = document.getElementById('plan-badge');
            badge.innerText = planRules.name;
            badge.className = `px-3 py-1 rounded-full text-xs font-bold border ${planRules.badgeClass}`;

            // Stats Cards
            document.getElementById('stat-views').innerText = currentData.stats?.views || 0;
            document.getElementById('stat-prods').innerText = products.length;
            document.getElementById('products-limit-badge').innerText = `Limit: ${planRules.limit}`;
            
            document.getElementById('stat-plan').innerText = planRules.name.toUpperCase();
            
            // Expiry Date Logic
            if(currentData.expiryDate) {
                const daysLeft = Math.ceil((new Date(currentData.expiryDate) - new Date()) / (1000 * 60 * 60 * 24));
                const expText = document.getElementById('stat-expiry');
                if (daysLeft < 0) {
                    expText.innerText = `Ø§Ù†ØªÙ‡Øª Ù…Ù†Ø° ${Math.abs(daysLeft)} ÙŠÙˆÙ…`;
                    expText.className = "text-xs text-red-400 font-bold";
                } else {
                    expText.innerText = `Ø¨Ø§Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ…`;
                    expText.className = "text-xs text-green-400 font-bold";
                }
            } else {
                document.getElementById('stat-expiry').innerText = "Ù…ÙØªÙˆØ­";
            }

            // Products Grid
            const grid = document.getElementById('products-grid');
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-400">
                        <i class="fa-solid fa-burger text-6xl mb-4 opacity-20"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>
                        <button onclick="openProductModal()" class="mt-4 text-orange-500 font-bold hover:underline">Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ù†ØªØ¬</button>
                    </div>`;
            } else {
                grid.innerHTML = products.map((p, index) => `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden group hover:shadow-md transition">
                        <div class="relative h-48 bg-gray-100">
                            <img src="${p.image}" class="w-full h-full object-cover" onerror="this.src='images/logo.png'">
                            <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-2 py-1 rounded-lg text-[10px] font-bold shadow-sm text-gray-700">${p.category}</div>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-gray-800 line-clamp-1">${p.name}</h3>
                                <span class="font-black text-orange-500 text-sm whitespace-nowrap">${p.price} Ø±.Ø³</span>
                            </div>
                            <p class="text-xs text-gray-400 line-clamp-2 min-h-[2.5em]">${p.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                            <div class="mt-4 pt-4 border-t border-gray-50 flex justify-end gap-2">
                                <button class="text-gray-400 hover:text-red-500 transition text-sm p-2" onclick="alert('Ø®Ø§ØµÙŠØ© Ø§Ù„Ø­Ø°Ù Ù‚Ø§Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹')"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Settings Fields
            document.getElementById('set-name').value = currentData.name;
            document.getElementById('set-phone').value = currentData.phone || '';
            document.getElementById('set-logo').value = currentData.logo || '';
            document.getElementById('set-color').value = currentData.themeColor || '#FF9F1C';

            // Color Lock Logic (Ø§Ù„Ø­Ù…Ø§ÙŠØ©)
            const colorSection = document.getElementById('color-section');
            const colorMsg = document.getElementById('color-msg');
            const colorInput = document.getElementById('set-color');

            if (!planRules.color) {
                colorSection.classList.add('locked-feature');
                colorInput.disabled = true;
                colorMsg.innerText = "ğŸ”’ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ÙˆØ§Ù„Ø¨Ù„Ø§ØªÙŠÙ†ÙŠØ© ÙÙ‚Ø·";
                colorMsg.className = "text-xs text-red-500 font-bold";
            } else {
                colorSection.classList.remove('locked-feature');
                colorInput.disabled = false;
                colorMsg.innerText = "ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®ØµÙŠØµ Ù„ÙˆÙ† Ø§Ù„Ù…Ù†ÙŠÙˆ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ù‡ÙˆÙŠØªÙƒ";
                colorMsg.className = "text-xs text-green-500";
            }

            // QR Code
            const menuUrl = window.location.origin + window.location.pathname.replace('client_dashboard.html', '') + `menu.html?id=${restId}`;
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(menuUrl)}`;
            document.getElementById('menu-link-text').innerText = menuUrl;
            document.getElementById('menu-link-text').href = menuUrl;

            // Chart
            renderChart(currentData.stats?.views || 0);
        }

        // 5. Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Actions)
        window.saveProduct = async () => {
            const planKey = currentData.plan || 'free';
            const planRules = PLANS_CONFIG[planKey];
            const currentCount = (currentData.products || []).length;

            // Guard: Check Limit
            if (currentCount >= planRules.limit) {
                alert(`â›” Ø¹ÙÙˆØ§Ù‹! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¨Ø§Ù‚Ø© ${planRules.name} (${planRules.limit} Ù…Ù†ØªØ¬).\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„ØªØ±Ù‚ÙŠØ©.`);
                return;
            }

            const name = document.getElementById('prod-name').value;
            const price = document.getElementById('prod-price').value;
            
            if(!name || !price) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø³Ø¹Ø±"); return; }

            const newProd = {
                name: name,
                price: Number(price),
                category: document.getElementById('prod-cat').value || 'Ø¹Ø§Ù…',
                image: document.getElementById('prod-img').value || 'images/logo.png',
                description: document.getElementById('prod-desc').value
            };

            // Save to Firebase
            try {
                await updateDoc(doc(db, "restaurants", restId), {
                    products: arrayUnion(newProd)
                });
                alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
                closeProductModal();
                initDashboard(); // Reload
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
            }
        }

        window.saveSettings = async () => {
            const planKey = currentData.plan || 'free';
            const planRules = PLANS_CONFIG[planKey];
            const newColor = document.getElementById('set-color').value;

            // Guard: Check Color Permission
            if (!planRules.color && newColor !== (currentData.themeColor || '#FF9F1C')) {
                alert("â›” ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ø¨Ø§Ù‚ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©!");
                return;
            }

            try {
                await updateDoc(doc(db, "restaurants", restId), {
                    name: document.getElementById('set-name').value,
                    phone: document.getElementById('set-phone').value,
                    logo: document.getElementById('set-logo').value,
                    themeColor: newColor
                });
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
                initDashboard();
            } catch (e) {
                alert("Ø®Ø·Ø£: " + e.message);
            }
        }

        // Helpers
        function renderChart(totalViews) {
            const ctx = document.getElementById('viewsChart');
            // Destroy old chart if exists (simple hack for this example)
            if(window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'],
                    datasets: [{
                        label: 'Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
                        data: [0, 0, 0, 0, 0, 0, totalViews], // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ±Ø¨Ø· Ø¨Ø¯Ø§ØªØ§ Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ùˆ Ø®Ø²Ù†Øª Ø²ÙŠØ§Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ©
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        window.openProductModal = () => {
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-price').value = '';
            document.getElementById('prod-img').value = '';
            document.getElementById('prod-desc').value = '';
            document.getElementById('product-modal').style.display = 'flex';
        }
        window.closeProductModal = () => document.getElementById('product-modal').style.display = 'none';
        
        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            btn.classList.add('active');
        };

        window.copyMenuLink = () => {
            const url = document.getElementById('menu-link-text').innerText;
            navigator.clipboard.writeText(url);
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!");
        };

        // Start
        initDashboard();
    </script>
</body>
</html>
