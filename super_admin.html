<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>i-Code | الإدارة العليا</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: white; }</style>
</head>
<body class="p-10">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-10 border-b border-gray-700 pb-5">
            <h1 class="text-2xl font-black text-blue-500">i-Code <span class="text-white">Manager</span></h1>
            <button onclick="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold transition"><i class="fa-solid fa-user-plus"></i> مشترك جديد</button>
        </div>

        <div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden">
            <table class="w-full text-right">
                <thead class="bg-gray-900 text-gray-400 text-sm">
                    <tr><th class="p-4">المطعم</th><th class="p-4">الإيميل</th><th class="p-4">التاريخ</th><th class="p-4">الرابط</th><th class="p-4">نسخ</th></tr>
                </thead>
                <tbody id="clients-table" class="text-gray-300 divide-y divide-gray-700">
                    <tr><td colspan="5" class="text-center p-4">جاري التحميل...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="add-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-gray-800 p-8 rounded-2xl w-full max-w-md border border-gray-600 shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-white">إضافة مشترك جديد</h3>
            <div class="space-y-4">
                <input type="text" id="clientName" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none" placeholder="اسم المطعم (مثال: واو بشاميل)">
                <input type="email" id="clientEmail" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none" placeholder="البريد الإلكتروني">
                <input type="password" id="clientPass" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none" placeholder="كلمة المرور">
                <input type="text" id="clientId" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white outline-none" placeholder="معرف الرابط (مثال: wow-bechamel)">
                <p class="text-xs text-gray-500">الرابط هيكون: menu.html?id=wow-bechamel</p>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="createClient()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">إنشاء</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-700 text-white py-3 rounded-xl font-bold">إلغاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth, setDoc, doc, createUserWithEmailAndPassword, collection, getDocs } from './firebase-config.js';

        async function loadClients() {
            const tableBody = document.getElementById('clients-table');
            try {
                const querySnapshot = await getDocs(collection(db, "restaurants"));
                tableBody.innerHTML = '';
                if (querySnapshot.empty) { tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">لا يوجد مشتركين</td></tr>'; return; }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    tableBody.innerHTML += `
                    <tr class="hover:bg-gray-700/50">
                        <td class="p-4 font-bold text-white">${data.name}</td>
                        <td class="p-4 text-sm text-gray-400">${data.email}</td>
                        <td class="p-4 text-sm">${new Date(data.createdAt).toLocaleDateString('ar-EG')}</td>
                        <td class="p-4"><a href="menu.html?id=${doc.id}" target="_blank" class="text-orange-400 hover:underline text-xs">فتح المنيو ↗</a></td>
                        <td class="p-4"><button onclick="navigator.clipboard.writeText('${window.location.origin + window.location.pathname.replace('super_admin.html', '')}menu.html?id=${doc.id}')" class="bg-gray-700 p-2 rounded text-white"><i class="fa-solid fa-copy"></i></button></td>
                    </tr>`;
                });
            } catch (error) { console.error(error); tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-red-500">حدث خطأ</td></tr>'; }
        }

        window.createClient = async function() {
            const name = document.getElementById('clientName').value;
            const email = document.getElementById('clientEmail').value;
            const pass = document.getElementById('clientPass').value;
            const uid = document.getElementById('clientId').value;
            if(!name || !email || !pass || !uid) { alert("أكمل البيانات!"); return; }
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "restaurants", uid), {
                    ownerId: cred.user.uid, name: name, email: email, themeColor: "#FF9F1C", logo: "images/logo.png", products: [], stats: { views: 0 }, isActive: true, createdAt: new Date().toISOString()
                });
                alert("✅ تم إنشاء المطعم!"); closeModal(); loadClients();
            } catch (e) { alert("خطأ: " + e.message); }
        }

        window.openModal = () => document.getElementById('add-modal').style.display = 'flex';
        window.closeModal = () => document.getElementById('add-modal').style.display = 'none';
        loadClients();
    </script>
</body>
</html>
