<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu Loading...</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: 'var(--brand-color)',
                        brandLight: 'var(--brand-light)',
                    },
                    fontFamily: {
                        tajawal: ['Tajawal', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --brand-color: #2563eb;
            --brand-light: #eff6ff;
            --brand-text-color: #ffffff;
            --menu-page-bg: #f8fafc;
        }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--menu-page-bg);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
        }
        
        /* Dynamic Header Class */
        .menu-header {
            background: linear-gradient(135deg, #2563eb 0%, #000 100%); /* Fallback */
            color: white;
        }

        /* General Button Class */
        .btn-main {
            background-color: var(--brand-color);
            color: var(--brand-text-color);
            transition: opacity 0.2s;
        }
        .btn-main:hover {
            opacity: 0.9;
        }
        
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Sticky Categories */
        .sticky-cats { position: sticky; top: 0; z-index: 40; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); }

        /* Loader */
        #loader { position: fixed; inset: 0; bg-white; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="bg-white"><div class="spinner"></div></div>

    <header class="menu-header shadow-sm p-4 relative z-20">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="rest-logo" src="" class="w-12 h-12 rounded-xl object-cover border border-gray-100 shadow-sm hidden">
                <div>
                    <h1 id="rest-name" class="font-bold text-lg text-white">...</h1>
                    <p id="table-info" class="text-xs text-gray-200 hidden"><i class="fa-solid fa-chair"></i> ÿ∑ÿßŸàŸÑÿ© ÿ±ŸÇŸÖ <span id="table-num"></span></p>
                </div>
            </div>
            <button onclick="app.toggleLang()" class="bg-white/20 px-3 py-1 rounded-lg text-xs font-bold text-white backdrop-blur-sm">EN/AR</button>
        </div>
        <p id="rest-desc" class="text-xs text-gray-200 mt-2 line-clamp-2"></p>
    </header>

    <div id="banners-area" class="p-4 hidden">
        <div class="flex overflow-x-auto gap-3 no-scrollbar snap-x snap-mandatory" id="banners-wrapper">
            </div>
    </div>

    <div class="sticky-cats border-b border-gray-100 shadow-sm">
        <div class="flex overflow-x-auto gap-2 p-3 no-scrollbar" id="cats-wrapper">
            </div>
    </div>

    <main class="p-4 min-h-[60vh]">
        <div id="products-container" class="grid gap-4">
            </div>
    </main>

    <div id="cart-btn" class="fixed bottom-4 left-4 right-4 btn-main p-4 rounded-2xl shadow-2xl flex justify-between items-center cursor-pointer z-50 transform translate-y-20 transition-all duration-300" onclick="app.openCart()">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center font-bold" id="cart-count">0</div>
            <span class="font-bold text-sm">ÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÑÿ©</span>
        </div>
        <span class="font-bold text-lg" id="cart-total">0.00</span>
    </div>

    <div id="prod-modal" class="fixed inset-0 bg-black/80 z-[60] hidden items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-all">
        <div class="bg-white w-full sm:max-w-md h-[90vh] sm:h-auto sm:rounded-3xl rounded-t-3xl overflow-y-auto relative animate-slide-up">
            <button onclick="app.closeModal()" class="absolute top-4 right-4 z-10 bg-white/80 p-2 rounded-full shadow-md"><i class="fa-solid fa-times"></i></button>
            <img id="modal-img" class="w-full h-64 object-cover bg-gray-100">
            <div class="p-6 pb-24">
                <div class="flex justify-between items-start mb-2">
                    <h2 id="modal-name" class="text-2xl font-black text-gray-800"></h2>
                    <span id="modal-price" class="text-xl font-bold text-brand"></span>
                </div>
                
                <div id="modal-badges" class="flex gap-2 mb-4"></div>
                
                <p id="modal-desc" class="text-gray-500 text-sm leading-relaxed mb-4"></p>
                
                <div class="flex gap-4 text-xs text-gray-400 mb-6 border-y py-3">
                    <span id="modal-cal" class="flex items-center gap-1"><i class="fa-solid fa-fire text-orange-500"></i> <span></span> Kcal</span>
                    <div id="modal-allergens" class="flex gap-2"></div>
                </div>

                <div class="flex items-center justify-between bg-gray-50 p-2 rounded-xl border">
                    <div class="flex items-center gap-4">
                        <button onclick="app.adjustQty(-1)" class="w-10 h-10 bg-white rounded-lg shadow text-gray-600 font-bold">-</button>
                        <span id="modal-qty" class="font-bold text-lg w-4 text-center">1</span>
                        <button onclick="app.adjustQty(1)" class="w-10 h-10 bg-white rounded-lg shadow text-brand font-bold">+</button>
                    </div>
                    <button onclick="app.addToCart()" class="btn-main px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30">ÿ•ÿ∂ÿßŸÅÿ©</button>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-modal" class="fixed inset-0 bg-black/80 z-[70] hidden justify-end transition-opacity">
        <div class="bg-white w-full sm:max-w-md h-full ml-auto flex flex-col relative shadow-2xl">
            <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-basket-shopping text-brand"></i> ÿ≥ŸÑÿ© ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</h3>
                <button onclick="app.closeCart()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto p-5 space-y-4">
                </div>

            <div class="p-6 border-t bg-gray-50 space-y-3">
                <div class="flex justify-between text-sm text-gray-500"><span>ÿßŸÑŸÖÿ¨ŸÖŸàÿπ</span><span id="bill-sub">0</span></div>
                <div class="flex justify-between text-sm text-gray-500"><span>ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ© (<span id="tax-rate">0</span>%)</span><span id="bill-tax">0</span></div>
                <div class="flex justify-between text-sm text-gray-500"><span>ÿßŸÑÿÆÿØŸÖÿ©</span><span id="bill-fees">0</span></div>
                <div class="flex justify-between text-xl font-black text-gray-800 border-t pt-2"><span>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</span><span id="bill-total" class="text-brand">0</span></div>
                
                <input type="text" id="cust-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" class="w-full border p-3 rounded-xl text-sm outline-none focus:border-brand">
                <textarea id="cust-note" placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™..." class="w-full border p-3 rounded-xl text-sm outline-none focus:border-brand h-16 resize-none"></textarea>
                
                <button onclick="app.checkout()" class="w-full btn-main hover:bg-green-700 py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-brands fa-whatsapp text-2xl"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, updateDoc, increment } from './firebase-config.js';

        window.app = {};
        
        // State
        let restaurant = {};
        let products = [];
        let cart = [];
        let currentModalProd = null;
        let modalQty = 1;
        
        // Params
        const urlParams = new URLSearchParams(window.location.search);
        const restId = urlParams.get('id');
        const tableNum = urlParams.get('table');
        const lang = localStorage.getItem('menu_lang') || 'ar';

        // --- Core ---
        app.init = async () => {
            if(!restId) return document.body.innerHTML = "<div class='p-10 text-center'>Error: No Restaurant ID provided in URL</div>";
            
            // Set Lang
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

            try {
                const snap = await getDoc(doc(db, "restaurants", restId));
                if(snap.exists()) {
                    restaurant = snap.data();
                    products = restaurant.products || [];
                    
                    // Increment Views (Analytics)
                    updateDoc(doc(db, "restaurants", restId), { "stats.views": increment(1) });
                    
                    app.renderUI();
                } else {
                    document.body.innerHTML = "<div class='p-10 text-center'>Restaurant not found</div>";
                }
            } catch(e) { console.error(e); }
            
            document.getElementById('loader').style.display = 'none';
        };

        app.renderUI = () => {
            // --- 1. Dynamic Colors & Theme ---
            const brandColor = restaurant.btnColor || restaurant.themeColor || '#2563eb';
            const brandText  = restaurant.textColor || '#ffffff';
            document.documentElement.style.setProperty('--brand-color', brandColor);
            document.documentElement.style.setProperty('--brand-text-color', brandText);

            // Header Background Logic
            const headerEl = document.querySelector('.menu-header');
            if (restaurant.menuBgType === 'image' && restaurant.menuBgImage) {
                headerEl.style.background = `linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.8) 100%), url('${restaurant.menuBgImage}')`;
                headerEl.style.backgroundSize = 'cover';
                headerEl.style.backgroundPosition = 'center';
            } else if (restaurant.menuBgType === 'color' && restaurant.menuBgColor) {
                headerEl.style.background = restaurant.menuBgColor;
            } else if (restaurant.themeColor) {
                headerEl.style.background = `linear-gradient(135deg, ${restaurant.themeColor} 0%, #000 100%)`;
            }

            // Page Background Logic
            if (restaurant.menuBgType === 'color' && restaurant.menuBgColor) {
                document.documentElement.style.setProperty('--menu-page-bg', restaurant.menuBgColor);
            } else {
                document.documentElement.style.setProperty('--menu-page-bg', '#f8fafc');
            }

            // --- 2. Branding Content ---
            document.title = restaurant.name;
            document.getElementById('rest-name').innerText = restaurant.name;
            document.getElementById('rest-desc').innerText = restaurant.desc || "";
            if(restaurant.logo) {
                document.getElementById('rest-logo').src = restaurant.logo;
                document.getElementById('rest-logo').classList.remove('hidden');
            }
            if(tableNum) {
                document.getElementById('table-info').classList.remove('hidden');
                document.getElementById('table-num').innerText = tableNum;
            }
            
            // --- 3. Banners ---
            if(restaurant.banners && restaurant.banners.length > 0) {
                const bWrapper = document.getElementById('banners-wrapper');
                bWrapper.innerHTML = restaurant.banners.map(b => `<img src="${b}" class="w-80 h-40 object-cover rounded-xl shadow-sm snap-center flex-shrink-0">`).join('');
                document.getElementById('banners-area').classList.remove('hidden');
            }

            // --- 4. Categories ---
            const cats = ["ÿßŸÑŸÉŸÑ", ...new Set(products.map(p => p.category))];
            const cWrapper = document.getElementById('cats-wrapper');
            cWrapper.innerHTML = cats.map((c, i) => `
                <button onclick="app.filterCats(this, '${c}')" class="cat-btn px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition ${i===0 ? 'btn-main shadow-lg' : 'bg-white text-gray-600 border border-gray-100'}">
                    ${c}
                </button>
            `).join('');

            // --- 5. Products ---
            app.renderProducts("ÿßŸÑŸÉŸÑ");
        };

        app.renderProducts = (cat) => {
            const container = document.getElementById('products-container');
            const layout = restaurant.layout || 'grid'; // grid or list
            
            // Set Layout Class
            container.className = layout === 'grid' ? "grid grid-cols-2 gap-4" : "flex flex-col gap-4";

            const filtered = cat === "ÿßŸÑŸÉŸÑ" ? products : products.filter(p => p.category === cat);

            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ</div>`;
                return;
            }

            container.innerHTML = filtered.map((p, i) => {
                const isStock = p.stock !== false;
                const badgesHtml = p.badges ? p.badges.map(b => `<span class="bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded shadow">${getBadgeName(b)}</span>`).join('') : '';
                
                return `
                <div onclick="app.openProdModal(${products.indexOf(p)})" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative cursor-pointer active:scale-95 transition fade-in ${!isStock ? 'opacity-60 grayscale' : ''}">
                    ${!isStock ? '<div class="absolute inset-0 z-10 flex items-center justify-center bg-black/10"><span class="bg-gray-800 text-white px-3 py-1 rounded-full text-xs font-bold">ŸÜŸÅÿ∞ÿ™ ÿßŸÑŸÉŸÖŸäÿ©</span></div>' : ''}
                    <div class="absolute top-2 right-2 flex flex-col gap-1 z-0">${badgesHtml}</div>
                    
                    <div class="${layout === 'grid' ? 'h-32' : 'h-48 w-full'} bg-gray-100">
                        <img src="${p.image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x300?text=No+Image'">
                    </div>
                    
                    <div class="p-3">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800 text-sm line-clamp-1">${p.name}</h3>
                            <span class="text-brand font-black text-sm">${p.price}</span>
                        </div>
                        ${layout === 'list' ? `<p class="text-xs text-gray-400 line-clamp-2 mt-1">${p.description || ''}</p>` : ''}
                    </div>
                </div>
            `}).join('');
        };

        app.filterCats = (btn, cat) => {
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.className = "cat-btn px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition bg-white text-gray-600 border border-gray-100";
            });
            btn.className = "cat-btn px-5 py-2 rounded-full text-sm font-bold whitespace-nowrap transition btn-main shadow-lg";
            app.renderProducts(cat);
        };

        // --- Interaction ---
        app.openProdModal = (idx) => {
            const p = products[idx];
            if(p.stock === false) return; // Can't open out of stock

            currentModalProd = p;
            modalQty = 1;
            
            document.getElementById('modal-img').src = p.image || '';
            document.getElementById('modal-name').innerText = p.name;
            document.getElementById('modal-price').innerText = p.price + ' ÿ±.ÿ≥';
            document.getElementById('modal-desc').innerText = p.description || '';
            document.getElementById('modal-cal').innerHTML = p.calories ? `<i class="fa-solid fa-fire text-orange-500"></i> ${p.calories} Kcal` : '';
            document.getElementById('modal-qty').innerText = 1;

            // Badges
            document.getElementById('modal-badges').innerHTML = (p.badges||[]).map(b => `<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-bold">${getBadgeName(b)}</span>`).join('');
            
            // Allergens
            document.getElementById('modal-allergens').innerHTML = (p.allergens||[]).map(a => `<span class="bg-gray-100 px-2 py-1 rounded text-[10px]">${a}</span>`).join('');

            document.getElementById('prod-modal').classList.remove('hidden');
            document.getElementById('prod-modal').classList.add('flex');
        };

        app.adjustQty = (d) => {
            modalQty += d;
            if(modalQty < 1) modalQty = 1;
            document.getElementById('modal-qty').innerText = modalQty;
        };

        app.addToCart = () => {
            const existing = cart.find(i => i.name === currentModalProd.name);
            if(existing) existing.qty += modalQty;
            else cart.push({ ...currentModalProd, qty: modalQty });
            
            app.closeModal();
            app.updateCartBtn();
            
            // Visual feedback
            const btn = document.getElementById('cart-btn');
            btn.classList.add('scale-110');
            setTimeout(() => btn.classList.remove('scale-110'), 200);
        };

        app.closeModal = () => {
            document.getElementById('prod-modal').classList.add('hidden');
            document.getElementById('prod-modal').classList.remove('flex');
        };

        // --- Cart Logic ---
        app.updateCartBtn = () => {
            const count = cart.reduce((a,b) => a+b.qty, 0);
            const total = cart.reduce((a,b) => a+(b.price*b.qty), 0);
            
            document.getElementById('cart-count').innerText = count;
            document.getElementById('cart-total').innerText = total.toFixed(2);
            
            if(count > 0) document.getElementById('cart-btn').classList.remove('translate-y-20');
            else document.getElementById('cart-btn').classList.add('translate-y-20');
        };

        app.openCart = () => {
            const wrapper = document.getElementById('cart-items');
            wrapper.innerHTML = cart.map((item, i) => `
                <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="bg-gray-100 w-12 h-12 rounded-lg flex items-center justify-center font-bold text-gray-500">${item.qty}x</div>
                        <div>
                            <h4 class="font-bold text-sm text-gray-800">${item.name}</h4>
                            <p class="text-xs text-brand font-bold">${item.price * item.qty} ÿ±.ÿ≥</p>
                        </div>
                    </div>
                    <button onclick="app.removeFromCart(${i})" class="text-red-400 p-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');

            // Financials
            const sub = cart.reduce((a,b) => a+(b.price*b.qty), 0);
            const taxRate = restaurant.tax || 0;
            const fees = restaurant.fees || 0;
            const taxVal = sub * (taxRate / 100);
            const total = sub + taxVal + fees;

            document.getElementById('bill-sub').innerText = sub.toFixed(2);
            document.getElementById('tax-rate').innerText = taxRate;
            document.getElementById('bill-tax').innerText = taxVal.toFixed(2);
            document.getElementById('bill-fees').innerText = fees.toFixed(2);
            document.getElementById('bill-total').innerText = total.toFixed(2) + ' ÿ±.ÿ≥';

            document.getElementById('cart-modal').classList.remove('hidden');
            document.getElementById('cart-modal').classList.add('flex');
        };

        app.removeFromCart = (i) => {
            cart.splice(i, 1);
            app.openCart(); // Re-render cart
            app.updateCartBtn();
            if(cart.length === 0) app.closeCart();
        };

        app.closeCart = () => {
            document.getElementById('cart-modal').classList.add('hidden');
            document.getElementById('cart-modal').classList.remove('flex');
        };

        app.checkout = () => {
            if(cart.length === 0) return;
            
            const name = document.getElementById('cust-name').value;
            const note = document.getElementById('cust-note').value;
            const total = document.getElementById('bill-total').innerText;
            
            let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ* üîî\n`;
            if(tableNum) msg += `üìç ÿ∑ÿßŸàŸÑÿ©: *${tableNum}*\n`;
            msg += `üë§ ÿßŸÑÿßÿ≥ŸÖ: ${name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}\n`;
            msg += `----------------\n`;
            
            cart.forEach(item => {
                msg += `‚ñ´Ô∏è ${item.qty}x ${item.name} (${item.price})\n`;
            });
            
            msg += `----------------\n`;
            msg += `üìù ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™: ${note}\n`;
            msg += `üí∞ *ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${total}*`;

            const phone = restaurant.phone || "";
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        // --- Helpers ---
        app.toggleLang = () => {
            const newLang = lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('menu_lang', newLang);
            location.reload();
        };

        function getBadgeName(key) {
            const badges = { 
                'new': 'ÿ¨ÿØŸäÿØ', 
                'bestseller': 'ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®ÿßŸã', 
                'promo': 'ÿπÿ±ÿ∂ ÿÆÿßÿµ', 
                'spicy': 'ÿ≠ÿßÿ±',
                'vegan': 'ŸÜÿ®ÿßÿ™Ÿä'
            };
            return badges[key] || key;
        }

        app.init();
    </script>
</body>
</html>
